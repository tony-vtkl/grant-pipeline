"""EligibilityResult - Output model for REQ-2 (VTKL Eligibility Assessment Engine)."""

from datetime import datetime
from typing import Optional
from pydantic import BaseModel, Field


class ConstraintCheck(BaseModel):
    """Individual constraint check result."""
    constraint_name: str
    is_met: bool
    details: Optional[str] = None


class EligibilityResult(BaseModel):
    """Result of eligibility assessment against VTKL profile.
    
    Generated by REQ-2, consumed by REQ-3 (scoring), REQ-4 (reports).
    """
    
    # Reference
    opportunity_id: str = Field(..., description="Links to GrantOpportunity.source_opportunity_id")
    
    # Overall result
    is_eligible: bool = Field(..., description="Pass/fail eligibility determination")
    participation_path: Optional[str] = Field(None, description="prime, subawardee, or None")
    
    # Constraint checks (per INTAKE BLOCK 2 acceptance criteria)
    entity_type_check: ConstraintCheck
    location_check: ConstraintCheck
    sam_active_check: ConstraintCheck
    naics_match_check: ConstraintCheck
    security_posture_check: ConstraintCheck
    certification_check: ConstraintCheck
    
    # Categorized findings
    blockers: list[str] = Field(default_factory=list, description="Disqualifying requirements")
    assets: list[str] = Field(default_factory=list, description="Favorable factors (e.g., NHO set-aside)")
    warnings: list[str] = Field(default_factory=list, description="Potential issues")
    
    # Metadata
    evaluated_at: datetime = Field(default_factory=datetime.utcnow)
    vtkl_profile_version: str = Field(default="1.0", description="VTKL profile version used")
    
    class Config:
        json_schema_extra = {
            "example": {
                "opportunity_id": "HHS-OS-24-001",
                "is_eligible": False,
                "participation_path": None,
                "entity_type_check": {
                    "constraint_name": "Entity Type",
                    "is_met": True,
                    "details": "For-profit corporation (required)"
                },
                "location_check": {
                    "constraint_name": "Location",
                    "is_met": True,
                    "details": "Hawaii-based (Honolulu)"
                },
                "sam_active_check": {
                    "constraint_name": "SAM Registration",
                    "is_met": True,
                    "details": "Active through 2026-11-11"
                },
                "naics_match_check": {
                    "constraint_name": "NAICS Match",
                    "is_met": True,
                    "details": "Primary 541511 matches"
                },
                "security_posture_check": {
                    "constraint_name": "Security Posture",
                    "is_met": True,
                    "details": "IL2-IL4 capable"
                },
                "certification_check": {
                    "constraint_name": "Certifications",
                    "is_met": False,
                    "details": "Requires 8(a) certification"
                },
                "blockers": ["Requires 8(a) certification â€” VTKL not currently certified"],
                "assets": [],
                "warnings": [],
                "evaluated_at": "2024-02-20T00:00:00Z",
                "vtkl_profile_version": "1.0"
            }
        }
